#!/bin/bash
set -euo pipefail

# ========== COLORS ==========
CYAN_PURPLE='\033[38;5;104m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ========== LOGGING ==========
log() { echo -e "${CYAN_PURPLE}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; exit 1; }
success() { echo -e "${GREEN}[DONE]${NC} $1"; }

# ========== CHECK INTERNET ==========
check_internet() {
    log "Checking internet connection..."
    if ! timeout 5 curl -sf http://1.1.1.1 > /dev/null 2>&1; then
        error "No internet connection."
    fi
    success "Internet connection OK."
}

# ========== BACKUP SOURCES ==========
backup_sources() {
    if [[ -f /etc/apt/sources.list ]]; then
        log "Backing up current sources.list..."
        sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak.$(date +%s)
    fi
}

# ========== MIRROR CONFIG TEMPLATES ==========
generate_ubuntu_sources() {
    local MIRROR_URL="$1"
    local CODENAME="$2"
    cat > /etc/apt/sources.list <<EOF
deb $MIRROR_URL/ubuntu/ $CODENAME main restricted
deb $MIRROR_URL/ubuntu/ $CODENAME-updates main restricted
deb $MIRROR_URL/ubuntu/ $CODENAME universe
deb $MIRROR_URL/ubuntu/ $CODENAME-updates universe
deb $MIRROR_URL/ubuntu/ $CODENAME multiverse
deb $MIRROR_URL/ubuntu/ $CODENAME-updates multiverse
deb $MIRROR_URL/ubuntu/ $CODENAME-backports main restricted universe multiverse
deb $MIRROR_URL/ubuntu/ $CODENAME-security main restricted
deb $MIRROR_URL/ubuntu/ $CODENAME-security universe
EOF
}

generate_debian_sources() {
    local MIRROR_URL="$1"
    local CODENAME="$2"
    cat > /etc/apt/sources.list <<EOF
deb $MIRROR_URL/debian/ $CODENAME main contrib non-free
deb $MIRROR_URL/debian/ $CODENAME-updates main contrib non-free
deb http://security.debian.org/debian-security $CODENAME-security main contrib non-free
EOF
}

# ========== APPLY MIRROR ==========
apply_mirror() {
    local name="$1"
    local url="$2"
    backup_sources
    if [[ "$ID" == "ubuntu" ]]; then
        log "Configuring Ubuntu repo for: $name"
        generate_ubuntu_sources "$url" "$CODENAME"
    elif [[ "$ID" == "debian" ]]; then
        log "Configuring Debian repo for: $name"
        generate_debian_sources "$url" "$CODENAME"
    fi
    success "Mirror '$name' applied."
}

restore_backup() {
    local latest_backup=$(ls /etc/apt/sources.list.bak.* 2>/dev/null | sort -nr | head -n1)
    if [[ -n "$latest_backup" ]]; then
        log "Restoring latest backup: $latest_backup"
        sudo cp "$latest_backup" /etc/apt/sources.list
        success "Backup restored."
    else
        warn "No backup found."
    fi
}

test_mirror_speed() {
    log "Testing mirror response times..."

    declare -A mirrors
    mirrors["Kartolo"]="http://kartolo.sby.datautama.net.id"
    mirrors["Buaya"]="http://buaya.klas.or.id"
    mirrors["Kebo"]="http://kebo.pens.ac.id"
    mirrors["Official_Ubuntu"]="http://archive.ubuntu.com"

    results=()
    for name in "${!mirrors[@]}"; do
        url="${mirrors[$name]}"
        if [[ "$ID" == "debian" ]] && [[ "$name" == *"Ubuntu"* ]]; then
            continue
        fi
        log "Testing: $name"
        if timeout 10 curl -sf --max-time 10 --head "$url" > /dev/null 2>&1; then
            time=$(curl -sf --max-time 10 -w "%{time_total}" -o /dev/null -s "$url")
            results+=("$time:$name:$url")
        else
            results+=("999:$name:UNREACHABLE")
        fi
    done

    IFS=$'\n' sorted=($(sort -n <<<"${results[*]}"))
    unset IFS

    echo -e "\n${CYAN_PURPLE}=== SPEED TEST RESULTS ===${NC}"
    for res in "${sorted[@]}"; do
        time="${res%%:*}"
        rest="${res#*:}"
        name="${rest%%:*}"
        if [[ "$time" == "999" ]]; then
            echo -e "  âŒ $name: unreachable"
        else
            printf "  âš¡ %.2f s â†’ %s\n" "$time" "$name"
        fi
    done
    echo -e "${CYAN_PURPLE}============================${NC}\n"
}

# ========== MIRROR MAP ==========
declare -A MIRROR_MAP
MIRROR_MAP["kartolo"]="http://kartolo.sby.datautama.net.id"
MIRROR_MAP["buaya"]="http://buaya.klas.or.id"
MIRROR_MAP["kebo"]="http://kebo.pens.ac.id"
MIRROR_MAP["official"]=""

choose_mirror_noninteractive() {
    local choice="$1"
    case "$choice" in
        kartolo|Kartolo)
            apply_mirror "Kartolo" "${MIRROR_MAP[kartolo]}"
            ;;
        buaya|Buaya)
            apply_mirror "Buaya" "${MIRROR_MAP[buaya]}"
            ;;
        kebo|Kebo)
            apply_mirror "Kebo" "${MIRROR_MAP[kebo]}"
            ;;
        official|Official)
            if [[ "$ID" == "ubuntu" ]]; then
                apply_mirror "Official" "http://archive.ubuntu.com"
            else
                apply_mirror "Official" "http://deb.debian.org"
            fi
            ;;
        restore)
            restore_backup
            exit 0
            ;;
        test)
            test_mirror_speed
            exit 0
            ;;
        *)
            error "Unknown mirror: $choice. Use: kartolo, buaya, kebo, official, restore, or test"
            ;;
    esac
}

# ========== INTERACTIVE MENU ==========
show_menu() {
    while true; do
        echo -e "\n${BLUE}Available Mirrors:${NC}"
        echo "[1] Kartolo (ID) â€” Surabaya"
        echo "[2] Buaya (ID) â€” Jakarta (KLAS)"
        echo "[3] Kebo (ID) â€” Surabaya (PENS)"
        echo "[4] Official (Global)"
        echo "[5] Restore backup"
        echo "[6] Test mirror speed"
        echo "[7] Exit"
        read -rp "Choose an option [1-7]: " choice

        case $choice in
            1) apply_mirror "Kartolo" "${MIRROR_MAP[kartolo]}"; break;;
            2) apply_mirror "Buaya" "${MIRROR_MAP[buaya]}"; break;;
            3) apply_mirror "Kebo" "${MIRROR_MAP[kebo]}"; break;;
            4)
                if [[ "$ID" == "ubuntu" ]]; then
                    apply_mirror "Official" "http://archive.ubuntu.com"
                else
                    apply_mirror "Official" "http://deb.debian.org"
                fi
                break;;
            5) restore_backup; exit 0;;
            6) test_mirror_speed;;
            7) log "Exiting."; exit 0;;
            *) warn "Invalid option. Please try again.";;
        esac
    done
}

# ========== MAIN ==========
main() {
    clear
    echo -e "${CYAN_PURPLE}ðŸ’œ Mirror Selector for Ubuntu/Debian ðŸ’œ${NC}"
    echo -e "${CYAN_PURPLE}   Optimized for Indonesian networks${NC}\n"

    check_internet

    if [[ ! -f /etc/os-release ]]; then error "Unsupported OS"; fi
    . /etc/os-release
    CODENAME=${VERSION_CODENAME:-bionic}

    if [[ "$ID" != "ubuntu" && "$ID" != "debian" ]]; then
        error "Only Ubuntu and Debian are supported."
    fi

    log "Detected: $(echo "$ID" | awk '{print toupper($0)}') ($CODENAME)"

    # Non-interactive mode if argument given
    if [[ $# -gt 0 ]]; then
        choose_mirror_noninteractive "$1"
    else
        show_menu
    fi

    log "Running apt update..."
    if sudo apt update -y; then
        success "Repository update completed!"
        log "You can now run 'apt upgrade' manually."
    else
        warn "apt update failed. Check your mirror selection."
    fi
}

main "$@"
