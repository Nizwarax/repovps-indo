#!/bin/bash
# ==========================================
#  REPO INDO ULTIMATE - AESTHETIC EDITION
# ==========================================

# Pastikan Root
if [[ $EUID -ne 0 ]]; then
   echo "Script harus dijalankan sebagai root!" 
   exit 1
fi

# === KONFIGURASI WARNA ===
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[0;33m'
export BLUE='\033[0;34m'
export PURPLE='\033[0;35m'
export CYAN='\033[0;36m'
export LIGHT='\033[0;37m'
export NC='\033[0m'

# === HELPER FUNCTIONS ===
print_info() { echo -e "${BLUE}➽ $1${NC}"; }
print_error() { echo -e "${RED}✘ ✘ $1${NC}"; }
print_success() { echo -e "${GREEN}✔ $1${NC}"; }

# === CEK INTERNET ===
check_internet() {
    if ! timeout 5 curl -sf http://1.1.1.1 > /dev/null 2>&1; then
        print_error "Tidak ada koneksi internet!"
        exit 1
    fi
}

# === DETEKSI REPO AKTIF (FITUR BARU) ===
get_current_mirror() {
    if [[ ! -f /etc/apt/sources.list ]]; then
        echo "Tidak Diketahui"
        return
    fi
    
    # Baca isi file
    local content=$(cat /etc/apt/sources.list)

    if [[ "$content" == *"kartolo"* ]]; then
        echo "Kartolo (ID)"
    elif [[ "$content" == *"buaya"* ]]; then
        echo "Buaya (ID)"
    elif [[ "$content" == *"kebo"* ]]; then
        echo "Kebo (PENS)"
    elif [[ "$content" == *"poliwangi"* ]]; then
        echo "Poliwangi (ID)"
    elif [[ "$content" == *"nus.edu.sg"* ]] || [[ "$content" == *"sg.debian.org"* ]]; then
        echo "Singapore (SG)"
    elif [[ "$content" == *"archive.ubuntu.com"* ]] || [[ "$content" == *"deb.debian.org"* ]]; then
        echo "Official (Global)"
    else
        echo "Custom / Mixed"
    fi
}

# === INFO SISTEM ===
get_os_info() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME="$PRETTY_NAME"
        CODE="$VERSION_CODENAME"
        if [[ -z "$CODE" ]]; then CODE="unknown"; fi
    else
        OS_NAME=$(uname -s)
        CODE="unknown"
    fi
    echo "$OS_NAME|$CODE"
}

# === TAMPILAN HEADER (MENU UTAMA) ===
show_banner() {
    clear
    # Ambil Info OS
    OS_DATA=$(get_os_info)
    OS_NAME=$(echo $OS_DATA | cut -d'|' -f1)
    OS_CODE=$(echo $OS_DATA | cut -d'|' -f2)
    
    # Ambil Info Repo Aktif
    CURRENT_REPO=$(get_current_mirror)
    
    echo -e "${YELLOW}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${YELLOW}│${NC} ${LIGHT}◈ REPO INDO MANAGER - PREMIUM EDITION ◈   ${NC}   ${YELLOW}│${NC}"
    echo -e "${YELLOW}│${NC} ${LIGHT}       Optimized for Indo & SG VPS       ${NC}    ${YELLOW}│${NC}"
    echo -e "${YELLOW}└──────────────────────────────────────────────┘${NC}"
    echo -e ""
    echo -e "${YELLOW}┌────────────${NC} ${LIGHT}◈ Informasi Sistem ◈ ${NC}${YELLOW}────────────┐${NC}"
    echo -e "${YELLOW}│${NC} ➽ OS         : $OS_NAME "
    echo -e "${YELLOW}│${NC} ➽ Codename   : ${GREEN}${OS_CODE^^}${NC} "
    echo -e "${YELLOW}│${NC} ➽ Repo Aktif : ${CYAN}$CURRENT_REPO${NC} "
    echo -e "${YELLOW}└──────────────────────────────────────────────┘${NC}"
}

# === SENI SELEBRASI (AESTHETIC SUCCESS) ===
show_success_art() {
    local msg="$1"
    clear
    echo -e "${GREEN}"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣴⠷⣶⣄⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⣿⣷⣾⠟⠛⠋⠁⠀⠈⠉⠛⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⠈⠉⣡⡴⠶⣤⠶⠷⣦⠀⣀⣈⠻⣿⡀⠀⠀⠀⠀⠀⠀"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣳⣾⣯⠀⠀⠀⠀⣤⡈⠉⠉⢹⡇⢹⣷⠀⠀⠀⠀⠀⠀"
    echo -e "⠀⠀⠀⠀⠀⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⢘⣿⠋⣤⡄⠀⣤⠀⢀⡈⠓⠀⣼⣿⣄⢸⣿⠀⠀⠀⠀⠀⠀"
    echo -e "⠀⠀⠀⣴⡿⠛⠛⣿⡧⠀⠀⠀⠀⠀⠀⣼⡟⠀⠛⢡⡾⠋⠀⠸⠇⠀⠀⣾⣿⣿⣾⠟⠀⠀⠀⠀⠀⠀"
    echo -e "⠀⠀⢸⣿⠀⠀⢰⣿⠇⠀⠀⠀⠀⠀⠀⣿⡇⢀⡀⠘⠗⠀⠀⣤⡀⠀⠀⠈⠛⢿⣿⠀⠀⠀⠀⠀⠀⠀"
    echo -e "⢀⣠⣨⣿⣆⠀⠹⣿⡄⠀⠀⠀⠀⠀⠀⢸⣿⠹⠯⣿⣒⣚⣭⠿⡟⠀⠀⢀⣠⣾⡿⠀⠀⠀⠀⠀⠀⠀"
    echo -e "⣿⠛⠉⠉⠛⠳⢦⡈⢿⣦⣀⠀⠀⠀⠀⠀⢻⣷⡀⠘⠛⠃⠀⠀⠀⢀⣴⣿⣟⠁⠀⠀⠀⠀⠀⠀⠀⠀"
    echo -e "⣿⠶⠶⠶⠦⣤⣨⡇⠀⣿⡿⢷⣶⣶⣦⣴⣾⣿⡟⠶⣤⣀⣀⡀⢘⣿⠏⢹⡟⠿⣷⣦⣀⠀⠀⠀⠀⠀"
    echo -e "⣿⣤⣤⣤⣀⣀⢙⡆⣰⢏⡇⠀⠀⠈⠉⠉⠀⠀⠳⣄⡈⠛⠛⠛⠋⠁⣀⣼⠃⠀⠀⠙⠻⣿⣦⡀⠀⠀"
    echo -e "⣿⡅⢰⣄⠈⠉⣻⢁⡽⣸⠃⠀⠀⠀⠀⠀⠀⠀⠀⠈⠙⠛⣦⠀⠀⢹⡋⠁⠀⠀⠀⠀⠀⠈⠻⣿⣆⠀"
    echo -e "⠘⠻⣶⣭⣿⣿⣿⣟⣱⠟⠀⠀⠀⠀⢀⣠⣾⠇⠀⠀⠀⠀⢹⠀⠀⠈⡇⠀⠀⢿⠀⠀⠀⠀⠀⠈⢻⡇"
    echo -e "⠀⠀⠀⠉⠉⠉⠛⠛⠿⣷⡖⠒⣶⡿⠛⣿⠀⠀⠀⠀⠀⠀⠸⡇⠀⠀⢹⠀⠀⢸⡆⣴⡖⠀⠀⠀⠀⣿"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣿⡆⠀⠀⠀⠀⠀⠀⡇⠀⠀⢸⡆⠀⠈⣿⠏⠀⠀⠀⠀⣰⠇"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣧⡀⠀⠀⠀⠀⠀⡇⠀⠀⠀⡇⣀⣴⢿⣀⡀⠀⠀⣰⡏⠀"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⡏⠙⠳⠶⠦⣤⣤⡇⠀⠀⠀⠛⠉⠀⢸⠉⠙⢷⣾⡟⠁⠀"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⣾⡆⣀⣼⡿⠀⠀⠀"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⠙⠷⢦⣤⣄⣀⣀⣠⣤⣤⡶⠾⠛⠉⢸⣇⣹⣿⠇⠀⠀⠀"
    echo -e "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⠀⠀⠀⠀⠈⠉⠉⠉⣄⠀⠀⠀⠀⠀⠀⣿⣿⠁⠀⠀⠀⠀"
    echo -e "${NC}"
    echo -e "${PURPLE}         [ $msg ]         ${NC}"
    echo -e ""
}

# === LOGIKA BACKUP & GENERATE ===
backup_sources() {
    if [[ -f /etc/apt/sources.list ]]; then
        print_info "Membackup sources.list lama..."
        cp /etc/apt/sources.list /etc/apt/sources.list.bak.$(date +%s)
    fi
}

generate_ubuntu_sources() {
    local MIRROR_URL="$1"
    local CODENAME="$2"
    cat > /etc/apt/sources.list <<EOF
deb $MIRROR_URL/ubuntu/ $CODENAME main restricted
deb $MIRROR_URL/ubuntu/ $CODENAME-updates main restricted
deb $MIRROR_URL/ubuntu/ $CODENAME universe
deb $MIRROR_URL/ubuntu/ $CODENAME-updates universe
deb $MIRROR_URL/ubuntu/ $CODENAME multiverse
deb $MIRROR_URL/ubuntu/ $CODENAME-updates multiverse
deb $MIRROR_URL/ubuntu/ $CODENAME-backports main restricted universe multiverse
deb $MIRROR_URL/ubuntu/ $CODENAME-security main restricted
deb $MIRROR_URL/ubuntu/ $CODENAME-security universe
EOF
}

generate_debian_sources() {
    local MIRROR_URL="$1"
    local CODENAME="$2"
    cat > /etc/apt/sources.list <<EOF
deb $MIRROR_URL/debian/ $CODENAME main contrib non-free
deb $MIRROR_URL/debian/ $CODENAME-updates main contrib non-free
deb http://security.debian.org/debian-security $CODENAME-security main contrib non-free
EOF
}

apply_mirror() {
    local name="$1"
    local url="$2"
    
    # Deteksi OS variables
    if [[ ! -f /etc/os-release ]]; then print_error "OS Tidak didukung"; exit 1; fi
    . /etc/os-release
    CODENAME=${VERSION_CODENAME:-bionic}
    
    backup_sources
    
    if [[ "$ID" == "ubuntu" ]]; then
        print_info "Configuring Ubuntu ($CODENAME) -> $name"
        generate_ubuntu_sources "$url" "$CODENAME"
    elif [[ "$ID" == "debian" ]]; then
        print_info "Configuring Debian ($CODENAME) -> $name"
        generate_debian_sources "$url" "$CODENAME"
    else
        print_error "OS bukan Ubuntu/Debian!"
        return
    fi
    
    print_info "Melakukan Update Repository..."
    if apt-get update -y; then
        show_success_art "MIRROR $name BERHASIL DIPASANG"
    else
        print_error "Gagal Update! Kembalikan backup dengan menu Restore."
    fi
}

restore_backup() {
    local latest_backup=$(ls /etc/apt/sources.list.bak.* 2>/dev/null | sort -nr | head -n1)
    if [[ -n "$latest_backup" ]]; then
        print_info "Mengembalikan backup: $latest_backup"
        cp "$latest_backup" /etc/apt/sources.list
        print_success "Backup berhasil direstore. Silakan jalankan update."
        read -p "Tekan Enter..."
    else
        print_error "Tidak ada file backup ditemukan."
        read -p "Tekan Enter..."
    fi
}

test_mirror_speed() {
    clear
    echo -e "${YELLOW}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${YELLOW}│${NC} ${LIGHT}           SPEED TEST MIRROR SERVER       ${NC} ${YELLOW}│${NC}"
    echo -e "${YELLOW}└──────────────────────────────────────────────┘${NC}"
    print_info "Sedang melakukan ping..."

    if [[ ! -f /etc/os-release ]]; then return; fi
    . /etc/os-release
    
    declare -A mirrors
    mirrors["Kartolo"]="http://kartolo.sby.datautama.net.id"
    mirrors["Buaya"]="http://buaya.klas.or.id"
    mirrors["Kebo"]="http://kebo.pens.ac.id"
    mirrors["Poliwangi"]="http://mirror.poliwangi.ac.id"
    mirrors["Official"]="http://archive.ubuntu.com"
    
    if [[ "$ID" == "ubuntu" ]]; then
        mirrors["Singapore"]="http://download.nus.edu.sg/mirror/ubuntu"
    else
        mirrors["Singapore"]="http://ftp.sg.debian.org"
    fi

    results=()
    for name in "${!mirrors[@]}"; do
        url="${mirrors[$name]}"
        if [[ "$ID" == "debian" ]] && [[ "$name" == *"Official"* ]]; then url="http://deb.debian.org/debian"; fi
        
        # Test URL Logic
        local test_url="$url"
        if [[ "$name" == "Singapore" && "$ID" == "debian" ]]; then test_url="$url/debian"; fi

        if timeout 5 curl -sf --max-time 5 --head "$test_url" > /dev/null 2>&1; then
            time=$(curl -sf --max-time 5 -w "%{time_total}" -o /dev/null -s "$test_url")
            results+=("$time:$name")
        else
            results+=("999:$name")
        fi
    done

    IFS=$'\n' sorted=($(sort -n <<<"${results[*]}"))
    unset IFS

    echo -e "\n${PURPLE}=== HASIL TEST KECEPATAN ===${NC}"
    for res in "${sorted[@]}"; do
        time="${res%%:*}"
        name="${res#*:}"
        if [[ "$time" == "999" ]]; then
            echo -e "${RED}  ❌ $name: Unreachable${NC}"
        else
            printf "${GREEN}  ⚡ %.3f det${NC} → %s\n" "$time" "$name"
        fi
    done
    echo ""
    read -p "Tekan Enter untuk kembali..."
}

# === SETUP MAP ===
declare -A MIRROR_MAP
MIRROR_MAP["kartolo"]="http://kartolo.sby.datautama.net.id"
MIRROR_MAP["buaya"]="http://buaya.klas.or.id"
MIRROR_MAP["kebo"]="http://kebo.pens.ac.id"
MIRROR_MAP["poliwangi"]="http://mirror.poliwangi.ac.id"

# === LOGIC SG & OFFICIAL ===
run_sg() {
    . /etc/os-release
    if [[ "$ID" == "ubuntu" ]]; then
        apply_mirror "Singapore (NUS)" "http://download.nus.edu.sg/mirror/ubuntu"
    else
        apply_mirror "Singapore (Debian)" "http://ftp.sg.debian.org"
    fi
}
run_official() {
    . /etc/os-release
    if [[ "$ID" == "ubuntu" ]]; then
        apply_mirror "Official" "http://archive.ubuntu.com"
    else
        apply_mirror "Official" "http://deb.debian.org"
    fi
}

# === MODE NON-INTERAKTIF (Command Line Arguments) ===
if [[ $# -gt 0 ]]; then
    check_internet
    case "$1" in
        kartolo) apply_mirror "Kartolo" "${MIRROR_MAP[kartolo]}" ;;
        buaya)   apply_mirror "Buaya" "${MIRROR_MAP[buaya]}" ;;
        kebo)    apply_mirror "Kebo" "${MIRROR_MAP[kebo]}" ;;
        poliwangi) apply_mirror "Poliwangi" "${MIRROR_MAP[poliwangi]}" ;;
        sg)      run_sg ;;
        official) run_official ;;
        restore) restore_backup ;;
        test)    test_mirror_speed ;;
        *)       print_error "Menu tidak dikenal!" ;;
    esac
    exit 0
fi

# === MAIN LOOP (INTERACTIVE MENU) ===
while true; do
    check_internet
    show_banner
    
    echo -e "${YELLOW} [1] ${NC} Kartolo (Surabaya)     ${GREEN}✅ Recommended${NC}"
    echo -e "${YELLOW} [2] ${NC} Buaya   (Jakarta - KLAS)"
    echo -e "${YELLOW} [3] ${NC} Kebo    (Surabaya - PENS)"
    echo -e "${YELLOW} [4] ${NC} Poliwangi (Banyuwangi)"
    echo -e "${YELLOW} [5] ${NC} Singapore (NUS/Debian)   ${CYAN}✈️  International${NC}"
    echo -e "${YELLOW} [6] ${NC} Official  (Global Default)"
    echo -e "${YELLOW}------------------------------------------------${NC}"
    echo -e "${PURPLE} [7] ${NC} Restore Backup (Kembali ke Awal)"
    echo -e "${BLUE} [8] ${NC} Test Kecepatan Mirror"
    echo -e "${RED} [9] ${NC} Keluar"
    echo ""
    echo -e -n "${LIGHT} Pilih Menu [1-9]: ${NC}"
    read choice

    case $choice in
        1) apply_mirror "Kartolo" "${MIRROR_MAP[kartolo]}"; read -p "Tekan Enter..." ;;
        2) apply_mirror "Buaya" "${MIRROR_MAP[buaya]}"; read -p "Tekan Enter..." ;;
        3) apply_mirror "Kebo" "${MIRROR_MAP[kebo]}"; read -p "Tekan Enter..." ;;
        4) apply_mirror "Poliwangi" "${MIRROR_MAP[poliwangi]}"; read -p "Tekan Enter..." ;;
        5) run_sg; read -p "Tekan Enter..." ;;
        6) run_official; read -p "Tekan Enter..." ;;
        7) restore_backup ;;
        8) test_mirror_speed ;;
        9) exit 0 ;;
        *) print_error "Pilihan salah!"; sleep 1 ;;
    esac
done
